---
title: "Cleaning & Wrangling"
author: "Brooke"
format: html
---

## Background



## Traits & Objectives

-   Relative Growth Rate
-   Photosynthetic Rate
-   Leaf Mass Area
-   Leaf Area
-   WUE 
-   Height
-   Leaf Nitrogen
-   Date of first flower
-   Mid season biomass
-   Root biomass
-   Root:shoot ratio
-   Root diameter
-   Specific root length
-   Root nitrogen


## Setup

```{r}
#| message: false
#| warning: false
#| echo: false
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(viridis)
library(lme4)
library(LeafArea)
#install.packages("naniar")
library(naniar)
```

## Relative Growth Rate

### Clean up dataset

```{r}
readin <- read_csv("RGR_2024.csv")

rgr <- readin
plots <- read_csv("Plot_info.csv")
rgr <- rgr %>% 
  select(
    Recorder,
    Date,
    Month,
    Plant_ID,
    Height_cm,
    Canopy_x_cm,
    Canopy_y_cm
  ) %>% 
  replace_with_na(replace = list(Height_cm = "N/A",
                                 Canopy_x_cm = "N/A",
                                 Canopy_y_cm = "N/A")) %>% 
  mutate(Height_cm = as.numeric(Height_cm),
         Canopy_x_cm = as.numeric(Canopy_x_cm),
         Canopy_y_cm = as.numeric(Canopy_y_cm))
str(rgr)
which(rgr$Canopy_x_cm == "N/A")

# Extract species code from ID
deconstruct <- function(name) {
  starts_with_23 <- substring(name,1,2) == "23"
  
  Age <- ifelse(starts_with_23,2,1)
  Sp_Code <- ifelse(starts_with_23,
                    substring(name,7,12),
                    substring(name,4,9))
  Plot <- ifelse(starts_with_23,
                 substring(name,4,5),
                 substring(name,1,2))
  out_df <- data.frame(Plant_ID = name, Age, Sp_Code,Plot, stringsAsFactors = FALSE)
  return(out_df)
}
out <- deconstruct(unique(rgr$Plant_ID))
unique(out$Plot)
str(out)
str(rgr)

# Extract plot, shelter letter from ID, add in block and population
rgr2 <- inner_join(rgr,out, by=join_by(Plant_ID)) 
rgr3 <- inner_join(rgr2,plots, by=join_by(Plot)) 

unique(rgr3$Sp_Code)

unique(rgr3$Shelter)

unique(rgr3$Plot)

# Find gaps, investigate

incomplete_rows <- rgr3[,c("Plant_ID","Month","Height_cm","Canopy_x_cm","Canopy_y_cm")]
incomplete_rows_2 <- incomplete_rows[!complete.cases(incomplete_rows),]
incomplete_rows_2 <- incomplete_rows_2[rowSums(is.na(incomplete_rows_2)) < 3,] # 3 for the three measurements -- if there are any rows with Height but not canopy, for example

# Investigate three odd balls

# Find and investigate outliers
# Good job for interns
# Find average and standard deviation for each species, each growth variable (make area first), per population per month
str(rgr3)
rgr3$area <- rgr3$Canopy_x_cm*rgr3$Canopy_y_cm

str(rgr3)

rgr_avgs <- rgr3 %>% 
  group_by(Sp_Code,
           Month,
           Treatment,
           Population,
           Age) %>% 
  mutate(ht_avg = mean(Height_cm, na.rm = TRUE),
            ht_sd = sd(Height_cm, na.rm = TRUE),
            area_avg = mean(area, na.rm = TRUE),
            area_sd = sd(area, na.rm = TRUE),
            x_avg = mean(Canopy_x_cm, na.rm = TRUE),
            x_sd = sd(Canopy_x_cm, na.rm = TRUE),
            y_avg = mean(Canopy_y_cm, na.rm = TRUE),
            y_sd = sd(Canopy_y_cm, na.rm = TRUE)) %>% 
  select(Plant_ID,
         Sp_Code,
         Month,
         Age,
         Treatment,
         Population,
         Height_cm,
         ht_avg,
         ht_sd,
         area,
         area_avg,
         area_sd,
         Canopy_x_cm,
         Canopy_y_cm,
         x_avg,
         x_sd,
         y_avg,
         y_sd)

rgr_avgs <- rgr_avgs[complete.cases(rgr_avgs),]

rgr_avgs <- rgr_avgs %>% 
  mutate(ht_max = ht_avg + 3*ht_sd,
         ht_min = ht_avg - 3*ht_sd,
         area_max = area_avg + 3*area_sd,
         area_min = area_avg - 3*area_sd,
         x_max = x_avg + 3*x_sd,
         x_min = x_avg - 3*x_sd,
         y_max = y_avg + 3*y_sd,
         y_min = y_avg - 3*y_sd)

ht_outliers <-rgr_avgs[which(rgr_avgs$Height_cm > rgr_avgs$ht_max | rgr_avgs$Height_cm < rgr_avgs$ht_min),c("Plant_ID","Sp_Code","Month","Population", "Treatment", "Height_cm","ht_avg","ht_sd","ht_min","ht_max")]

area_outliers <- rgr_avgs[which(rgr_avgs$area > rgr_avgs$area_max | rgr_avgs$area < rgr_avgs$area_min),c("Plant_ID","Sp_Code","Month","Population", "Treatment", "area","area_avg","area_sd","area_min","area_max")]

x_outliers <- rgr_avgs[which(rgr_avgs$Canopy_x_cm > rgr_avgs$x_max | rgr_avgs$Canopy_x_cm < rgr_avgs$x_min),c("Plant_ID","Sp_Code","Month","Population", "Treatment", "Canopy_x_cm","x_avg","x_sd","x_min","x_max")]

y_outliers <- rgr_avgs[which(rgr_avgs$Canopy_y_cm > rgr_avgs$y_max | rgr_avgs$Canopy_y_cm < rgr_avgs$y_min),c("Plant_ID","Sp_Code","Month","Population", "Treatment", "Canopy_y_cm","y_avg","y_sd","y_min","y_max")]

## No outliers for 3 SD from mean, investigate blanks
```

### Create variables

```{r}
# Calculate canopy volume (height x canopy area)
head(rgr3)
rgr3$volume <- rgr3$Height_cm*rgr3$Canopy_x_cm*rgr3$Canopy_y_cm
rgr3$Date <- as.Date(rgr3$Date, tryFormats = "%m/%d/%y")
str(rgr3)

# Separate by metric

rgr_h_wide <- rgr3 %>% 
  select(Plant_ID,
         Date,
         Month,
         Height_cm) %>% 
  filter(!is.na(Height_cm)) %>%
  pivot_wider(id_cols = Plant_ID,
              names_from = Month,
              values_from = c(Date, Height_cm)) %>% 
  mutate(rgr_h_FM = (log(Height_cm_March)-log(Height_cm_February))/as.numeric((Date_March-Date_February)),
         rgr_h_MA = (log(Height_cm_April)-log(Height_cm_March))/as.numeric((Date_April-Date_March)),
         rgr_h_AM = (log(Height_cm_May)-log(Height_cm_April))/as.numeric((Date_May-Date_April)),
         rgr_h_MJ = (log(Height_cm_June)-log(Height_cm_May))/as.numeric((Date_June-Date_May)))

rgr_v_wide <- rgr3 %>% 
  select(Plant_ID,
         Date,
         Month,
         volume) %>% 
  filter(!is.na(volume)) %>%
  pivot_wider(id_cols = Plant_ID,
              names_from = Month,
              values_from = c(Date, volume)) %>% 
  mutate(rgr_v_FM = (log(volume_March)-log(volume_February))/as.numeric((Date_March-Date_February)),
         rgr_v_MA = (log(volume_April)-log(volume_March))/as.numeric((Date_April-Date_March)),
         rgr_v_AM = (log(volume_May)-log(volume_April))/as.numeric((Date_May-Date_April)),
         rgr_v_MJ = (log(volume_June)-log(volume_May))/as.numeric((Date_June-Date_May)))
  
# Join all three together but only keep rgrs, full join by Plant_ID

rgr_hv <- full_join(rgr_h_wide,rgr_v_wide,by = join_by(Plant_ID))

rgr_hv2 <- rgr_hv %>% 
  select(
    Plant_ID,
    rgr_h_FM,
    rgr_h_MA,
    rgr_h_AM,
    rgr_h_MJ,
    rgr_v_FM,
    rgr_v_MA,
    rgr_v_AM,
    rgr_v_MJ
  )

## Wooooo we did it!
## Now just need to address outliers and re-run
## For now you're done!
```

### Exploratory Graphs


### Select Reference times
One predictive variable of allometric slope might be relative growth rate timing and/or maximum relative growth rate.

## Photosynthetic Rate

### Read in & bind

```{r}
#| warning: false

# how to tell it the header and which rows to skip
# how to read through the filenames in a certain folder and make a list and then read those in 1 by 1

licor_files <- list.files("/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/licor")
licor_files[4]
?read_csv
trial <- read_csv(licor_files[4], skip = 1, col_select = "obs":"gtc")

lic <- list() # creates a list
for (k in 1:length(licor_files)){
 lic[[k]] <- read_csv(licor_files[k], skip = 1, col_select = "obs":"gtc")
}

# from Ch 1 code, not sure what it does but it brings up an error
#lic <- lapply(lic, function(tbl) {
#  tbl$WUE <- as.numeric(tbl$WUE)
#  return(tbl)
#})

licor <- bind_rows(lic)
licor <- licor %>% 
  filter(!is.na(obs))

```

Now I need to bring in Licor leaf area csv and join. Also need to double check numbers for each species.

GALPAR, Holvir, miccal not working -- fixed, just needed to adjust minimum size.

```{r}
#| eval: false
aircar = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/AIRCAR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
aircar<-aircar$summary

amsmen = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/AMSMEN",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
amsmen<-amsmen$summary

avebar = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/AVEBAR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
avebar<-avebar$summary

avefat = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/AVEFAT",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
avefat<-avefat$summary

broare = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/BROARE",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
broare<-broare$summary

brodia = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/BRODIA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
brodia<-brodia$summary

brohor = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/BROHOR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
brohor<-brohor$summary

bromad = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/BROMAD",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
bromad<-bromad$summary

caucou = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/CAUCOU",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
caucou<-caucou$summary

cenmel = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/CENMEL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
cenmel<-cenmel$summary

clapur = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/CLAPUR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
clapur<-clapur$summary

corfil = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/CORFIL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
corfil<-corfil$summary

dancal = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/DANCAL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
dancal<-dancal$summary

daupus = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/DAUPUS",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
daupus<-daupus$summary

elycap = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/ELYCAP",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
elycap<-elycap$summary

erocic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/EROCIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
erocic<-erocic$summary

esccal = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/ESCCAL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
esccal<-esccal$summary


galpar = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/GALPAR", 
                distance.pixel = 355, 
                known.distance = 3,
                low.size = 0.005,
                log = TRUE)
          #      save.image = TRUE)
galpar<-galpar$summary

gerdis = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/GERDIS",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
gerdis<-gerdis$summary

holvir = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/HOLVIR", 
                distance.pixel = 355, 
                known.distance = 3, 
                low.size = 0.005,
                log = TRUE)
                # save.image = TRUE)
holvir<-holvir$summary

hypgla = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/HYPGLA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
hypgla<-hypgla$summary

lupbic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/LUPBIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
lupbic<-lupbic$summary

lupmic = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/LUPMIC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
lupmic<-lupmic$summary

lupsuc = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/LUPSUC",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
lupsuc<-lupsuc$summary

madgra = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/MADGRA",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
madgra<-madgra$summary

miccal = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/MICCAL", 
                distance.pixel = 355, 
                known.distance = 3, 
                low.size = 0.005,
                log = TRUE)
             #   save.image = TRUE)
miccal<-miccal$summary

mirmul = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/MIRMUL", 
                distance.pixel = 355, 
                known.distance = 3, 
                low.size = 0.005,
                log = TRUE)
             #   save.image = TRUE)
mirmul<-mirmul$summary

phatan = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/PHATAN",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
phatan<-phatan$summary

plaere = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/PLAERE",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
plaere<-plaere$summary

planot = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/PLANOT",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
planot<-planot$summary

salcol = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/SALCOL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
salcol<-salcol$summary

sanbip = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/SANBIP",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
sanbip<-sanbip$summary

stipul = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/STIPUL",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
stipul<-stipul$summary

torarv = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/TORARV",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
torarv<-torarv$summary

trihir = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/TRIHIR",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
trihir<-trihir$summary

vicsat = run.ij(set.directory = "/Users/brookewainwright/Documents/GitHub_Projects/drought_frameworks/Licor Leaf Area copy/VICSAT",
              distance.pixel = 355,
              known.distance = 3,
              log = TRUE,
              low.size = 0.005)
vicsat<-vicsat$summary

# missing galpar, miccal, holvir
leaf_licor_area <- rbind(aircar,
                         amsmen,
                         avebar,
                         avefat,
                         broare,
                         brodia,
                         brohor,
                         bromad,
                         caucou,
                         cenmel,
                         clapur,
                         corfil,
                         dancal,
                         daupus,
                         elycap,
                         erocic,
                         esccal,
                         galpar,
                         gerdis,
                         holvir,
                         hypgla,
                         lupbic,
                         lupmic,
                         lupsuc,
                         madgra,
                         miccal,
                         mirmul,
                         phatan,
                         plaere,
                         planot,
                         salcol,
                         sanbip,
                         stipul,
                         torarv,
                         trihir,
                         vicsat)

leaf_licor_area$sample <- as.character(leaf_licor_area$sample)
leaf_licor_area$sample[which(nchar(leaf_licor_area$sample) < 18)]

write_csv(leaf_licor_area, "leaf_licor_area.csv")
```

Double check that the numbers of values per species aligns with number of images per species folder. -- All good

Then merge with Licor dataset by plant ID.

LEFT OFF HERE

```{r}
#| eval: false
# Separate date from plant ID, make in date format
leaf_licor_area <- read_csv("leaf_licor_area.csv")
head(leaf_licor_area)
head(licor)

licor$Date <- as.Date(substr(licor$date, start=1, stop=10))
str(licor$Date)

leaf_licor_area$Date <- as.Date(substr(leaf_licor_area$sample, start=11, stop=18), "%Y%m%d")
str(licor$Date)

# separate plant ID from same and add periods to plant id
leaf_licor_area$Plant_ID <- substr(leaf_licor_area$sample, start=1,stop=9)
leaf_licor_area$Plant_ID <- paste0(
  substr(leaf_licor_area$Plant_ID, 1, 2),
  ".",
  substr(leaf_licor_area$Plant_ID, 3, nchar(leaf_licor_area$Plant_ID))
)
leaf_licor_area$Plant_ID

leaf_licor_area$Plant_ID <- paste0(
  substr(leaf_licor_area$Plant_ID, 1, 9),
  ".",
  substr(leaf_licor_area$Plant_ID, 10, nchar(leaf_licor_area$Plant_ID))
)
leaf_licor_area$Plant_ID

# capitalize Licor plant id
licor$Plant_ID <- toupper(licor$`plant id`)

# merge with licor leaf area
licor2 <- left_join(licor,leaf_licor_area,by=c("Plant_ID" = "Plant_ID"))

# Come back and investigate NAs for licor2 -- why are some leaf areas missing

# multiply focal data by leaf area fraction
licor2$leaf_ratio <- 6/licor2$total.leaf.area
licor2 <- licor2 %>% 
  filter(!is.na(total.leaf.area)) %>% # filter NAs for now
  mutate(WUE_adj = leaf_ratio*WUE,
         E_adj = leaf_ratio*as.numeric(E),
         A_adj = leaf_ratio*as.numeric(A),
         Ci_adj = leaf_ratio*as.numeric(Ci),
         gsw_adj = leaf_ratio*as.numeric(gsw))
str(licor2)

# remove licor data with gsw below threshold
licor2[which(licor2$gsw_adj < 0.03),]

# There are values from September 2020???? investigate
# Weirdly this file 2023-04-30-0922_BRODIA_39.csv has the date at Sep 2020, some glitch. will need to fix
# September 23, 2020

# test for licor outliers by species, population, and treatment



# average licor data by plant_id



# extract species and plot from plant id

```

